<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dyslexia ML Reading Assistant</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f172a;
      --panel: #0b2530;
      --accent: #0ea5e9;
      --accent-2: #fbbf24;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --positive: #34d399;
      --warning: #fb923c;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Space Grotesk', system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(14,165,233,0.12), transparent 35%),
                  radial-gradient(circle at 80% 0%, rgba(251,191,36,0.10), transparent 35%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-bottom: 1px solid rgba(148,163,184,0.15);
      backdrop-filter: blur(12px);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 { margin: 0; font-size: 20px; letter-spacing: 0.4px; }
    header .tag {
      padding: 6px 12px;
      border-radius: 12px;
      background: rgba(14,165,233,0.15);
      color: var(--accent);
      font-size: 13px;
      border: 1px solid rgba(14,165,233,0.25);
    }
    main { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; padding: 20px 24px 32px; }
    .panel {
      background: var(--panel);
      border: 1px solid rgba(148,163,184,0.15);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.28);
    }
    h2 { margin: 0 0 8px; font-size: 18px; }
    p.small { margin: 4px 0 12px; color: var(--muted); font-size: 14px; }
    textarea, input, button { font-family: 'Space Grotesk', system-ui, -apple-system, sans-serif; }
    textarea {
      width: 100%;
      min-height: 180px;
      background: rgba(226,232,240,0.03);
      border: 1px solid rgba(148,163,184,0.25);
      color: var(--text);
      border-radius: 12px;
      padding: 12px;
      resize: vertical;
    }
    .controls { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    button {
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: linear-gradient(120deg, var(--accent), #22d3ee);
      color: #0b1b26;
      font-weight: 600;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease;
    }
    button.secondary {
      background: rgba(148,163,184,0.12);
      color: var(--text);
      border-color: rgba(148,163,184,0.3);
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(14,165,233,0.25); }
    .stack { display: grid; gap: 12px; }
    .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap: 10px; }
    .metric {
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(226,232,240,0.04);
      border: 1px solid rgba(148,163,184,0.2);
    }
    .metric .label { color: var(--muted); font-size: 13px; }
    .metric .value { font-size: 18px; font-weight: 700; }
    .output {
      background: rgba(226,232,240,0.05);
      border: 1px dashed rgba(148,163,184,0.4);
      border-radius: 12px;
      padding: 12px;
      min-height: 100px;
      white-space: pre-line;
    }
    .mentor {
      background: linear-gradient(135deg, rgba(14,165,233,0.16), rgba(251,191,36,0.12));
      border: 1px solid rgba(14,165,233,0.25);
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(251,191,36,0.12);
      color: var(--accent-2);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      margin-right: 6px;
      border: 1px solid rgba(251,191,36,0.3);
    }
    footer { text-align: center; color: var(--muted); padding: 12px 0 20px; font-size: 13px; }
    @media (max-width: 900px) { main { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>Lexy-inspired Dyslexia Coach</h1>
    <div class="tag">Adaptive · Multisensory · Supportive</div>
  </header>

  <main>
    <section class="panel stack">
      <div>
        <h2>Reading Workspace</h2>
        <p class="small">Paste a passage, highlight a word, then run the modules below.</p>
        <textarea id="readingText">The quick brown fox jumps over the lazy dog. This prototype simulates ASR and attention, then adapts the reading plan.</textarea>
        <input id="targetWord" placeholder="Word to practice (optional)" style="margin-top:8px;width:100%;padding:10px;border-radius:10px;border:1px solid rgba(148,163,184,0.25);background:rgba(226,232,240,0.03);color:var(--text);" />
        <div class="controls">
          <button onclick="runSpeech()">Analyze Speech (mock)</button>
          <button onclick="recordAndAnalyze()">Record + Whisper</button>
          <button class="secondary" onclick="runAttention()">Check Focus</button>
          <button class="secondary" onclick="runAdapt()">Plan Difficulty</button>
          <button onclick="runAssist()">Assist Me</button>
          <button class="secondary" onclick="runMentor()">Mentor Coach</button>
          <button class="secondary" onclick="logSession()">Log Session</button>
        </div>
        <div class="controls">
          <button class="secondary" onclick="startMic()">Arm Mic</button>
          <button class="secondary" onclick="startCam()">Start Cam Stream</button>
          <span id="capStatus" class="small" style="color:var(--muted);">Mic/Cam idle</span>
        </div>
      </div>
      <div class="metrics">
        <div class="metric"><div class="label">Accuracy</div><div class="value" id="m-accuracy">—</div></div>
        <div class="metric"><div class="label">Pace (wpm)</div><div class="value" id="m-pace">—</div></div>
        <div class="metric"><div class="label">Focus</div><div class="value" id="m-focus">—</div></div>
        <div class="metric"><div class="label">Next Level</div><div class="value" id="m-level">—</div></div>
      </div>
      <div class="output" id="output">Run a module to see feedback.</div>
    </section>

    <section class="panel mentor">
      <h2>Mentor Persona</h2>
      <p class="small">Personalized encouragement grounded in speech + attention signals.</p>
      <div id="mentorMessage" style="font-weight:700;margin-bottom:8px;">Hi there! I'm ready to coach.</div>
      <div id="mentorSummary" class="small"></div>
      <div style="margin-top:10px;">
        <span class="pill">Adaptive cues</span>
        <span class="pill">TTS + highlights</span>
        <span class="pill">Focus-aware</span>
      </div>
    </section>
  </main>

  <footer>
    Mocked endpoints only. Connect to FastAPI at http://localhost:8000 for live calls.
  </footer>

  <script>
    const API_BASE = 'http://localhost:8000';

    const output = document.getElementById('output');
    const accuracyEl = document.getElementById('m-accuracy');
    const paceEl = document.getElementById('m-pace');
    const focusEl = document.getElementById('m-focus');
    const levelEl = document.getElementById('m-level');
    const mentorMsg = document.getElementById('mentorMessage');
    const mentorSummary = document.getElementById('mentorSummary');
    const capStatus = document.getElementById('capStatus');

    let lastAccuracy = 0.8;
    let lastPace = 115;
    let lastFocus = 0.7;
    let lastLevel = 'A1';
    let audioStream = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let videoStream = null;
    let frameTimer = null;
    const hiddenVideo = document.createElement('video');
    hiddenVideo.playsInline = true;
    const hiddenCanvas = document.createElement('canvas');

    async function postJson(path, body) {
      const res = await fetch(`${API_BASE}${path}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if (!res.ok) throw new Error(`Request failed: ${res.status}`);
      return res.json();
    }

    function setOutput(text) { output.textContent = text; }

    async function recordAndAnalyze() {
      try {
        if (!audioStream) await startMic();
        if (!audioStream) throw new Error('Mic not available');
        audioChunks = [];
        mediaRecorder = new MediaRecorder(audioStream);
        mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) audioChunks.push(e.data); };
        mediaRecorder.start();
        setOutput('Recording 4s...');
        await new Promise(res => setTimeout(res, 4000));
        const stopPromise = new Promise(res => { mediaRecorder.onstop = res; });
        mediaRecorder.stop();
        await stopPromise;
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        const form = new FormData();
        form.append('file', blob, 'recording.webm');
        form.append('reference_text', document.getElementById('readingText').value);
        const res = await fetch(`${API_BASE}/listen/upload`, { method: 'POST', body: form });
        if (!res.ok) throw new Error(`Upload failed: ${res.status}`);
        const data = await res.json();
        accuracyEl.textContent = `${Math.round(data.accuracy * 100)}%`;
        paceEl.textContent = `${data.pace_wpm}`;
        lastAccuracy = data.accuracy;
        lastPace = data.pace_wpm;
        setOutput(`Transcript: ${data.transcript}\nCoaching: ${data.coaching_tip}`);
      } catch (err) {
        setOutput(err.message);
      }
    }

    async function runSpeech() {
      try {
        const text = document.getElementById('readingText').value;
        const data = await postJson('/listen/analyze', { reference_text: text });
        accuracyEl.textContent = `${Math.round(data.accuracy * 100)}%`;
        paceEl.textContent = `${data.pace_wpm}`;
        lastAccuracy = data.accuracy;
        lastPace = data.pace_wpm;
        const errs = data.errors.map(e => `• ${e.word}: ${e.hint}`).join('\n') || 'No major errors detected.';
        setOutput(`Transcript: ${data.transcript}\nCoaching: ${data.coaching_tip}\n${errs}`);
      } catch (err) {
        setOutput(err.message);
      }
    }

    async function runAttention() {
      try {
        const data = await postJson('/observe/analyze', { focus_signal: 0.72, blink_rate: 14, session_duration_sec: 420 });
        focusEl.textContent = data.focus_score;
        lastFocus = data.focus_score;
        setOutput(`Focus: ${data.focus_score} | Fatigue: ${data.fatigue_score} | ${data.note}`);
      } catch (err) { setOutput(err.message); }
    }

    async function runAdapt() {
      try {
        const data = await postJson('/adapt/plan', { pace_wpm: lastPace, error_rate: 0.12, focus_score: lastFocus, current_level: lastLevel, prev_focus_score: lastFocus, prev_pace_wpm: lastPace, prev_error_rate: 0.12 });
        levelEl.textContent = data.next_level;
        lastLevel = data.next_level;
        setOutput(`Speed: ${data.reading_speed_wpm} wpm | Font: ${data.font_size_px}px | Spacing: ${data.spacing_em}em | Hints: ${data.hint_frequency}\n${data.rationale}`);
      } catch (err) { setOutput(err.message); }
    }

    async function runAssist() {
      try {
        const text = document.getElementById('readingText').value;
        const target = document.getElementById('targetWord').value;
        const data = await postJson('/assist/assist', { text, target_word: target });
        setOutput(`Highlight spans: ${JSON.stringify(data.highlights)}\nNarration speed: ${data.narration_speed}`);
      } catch (err) { setOutput(err.message); }
    }

    async function runMentor() {
      try {
        const data = await postJson('/mentor/coach', { learner_name: 'You', tone: 'friendly', focus_score: lastFocus, accuracy: lastAccuracy, pace_wpm: lastPace, level: lastLevel, fatigue_score: 0.3, distraction_flag: false });
        mentorMsg.textContent = `${data.persona}: ${data.message}`;
        mentorSummary.textContent = data.summary.join(' • ');
        setOutput(`Next actions: ${data.next_actions.join('; ')}`);
      } catch (err) { setOutput(err.message); }
    }

    async function logSession() {
      try {
        const payload = {
          learner_name: 'You',
          accuracy: lastAccuracy,
          focus_score: lastFocus,
          pace_wpm: lastPace,
          level: lastLevel,
          note: 'Quick log from prototype UI'
        };
        const data = await postJson('/sessions/log', payload);
        setOutput(`Session stored with id ${data.id} at ${data.created_at}`);
      } catch (err) { setOutput(err.message); }
    }

    async function startMic() {
      try {
        audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        capStatus.textContent = 'Mic ready';
      } catch (err) {
        capStatus.textContent = 'Mic blocked';
        setOutput(err.message);
      }
    }

    async function startCam() {
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({ video: { width: 320, height: 240 } });
        hiddenVideo.srcObject = videoStream;
        await hiddenVideo.play();
        capStatus.textContent = 'Cam streaming';
        if (frameTimer) clearInterval(frameTimer);
        frameTimer = setInterval(captureFrame, 1500);
      } catch (err) {
        capStatus.textContent = 'Cam blocked';
        setOutput(err.message);
      }
    }

    async function captureFrame() {
      if (!hiddenVideo.videoWidth) return;
      hiddenCanvas.width = hiddenVideo.videoWidth;
      hiddenCanvas.height = hiddenVideo.videoHeight;
      const ctx = hiddenCanvas.getContext('2d');
      ctx.drawImage(hiddenVideo, 0, 0, hiddenCanvas.width, hiddenCanvas.height);
      const dataUrl = hiddenCanvas.toDataURL('image/jpeg', 0.7);
      const base64 = dataUrl.split(',')[1];
      try {
        const data = await postJson('/observe/analyze', { focus_signal: lastFocus, blink_rate: 14, session_duration_sec: 120, frame_base64: base64 });
        focusEl.textContent = data.focus_score;
        lastFocus = data.focus_score;
        capStatus.textContent = `Cam focus ${data.focus_score}`;
      } catch (err) {
        capStatus.textContent = 'Cam error';
      }
    }
  </script>
</body>
</html>
